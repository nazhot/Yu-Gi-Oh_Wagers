<!DOCTYPE html>
<html>
  <head>
    <title>Yu-Gi-Oh Wager</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/general.css"/>
    <link rel="stylesheet" href="/home-page.css" />
    <link rel="stylesheet" href="/wagering-page.css" />
  </head>
  <body>
    <div id="home-page" class="screen-container">
      <label for="token-count" class="player-1-element" style="display: none">Tokens</label>
      <input type="number" name="token-count" id="token-count" class="player-1-element" style="display: none">
      <button type="button" id="start-game-button" class="player-1-element" style="display: none" onclick="submitStartGame()">Start Game</button>
      <p id="opponent-connected" style="display: none">Opponent Connected!</p>
      <button type="button" id="player-ready-button" class="not-ready" onclick="swapReadyStatus(this)">NOT READY</button>
    </div>
    <div id="wagering-page" class="screen-container" style="display:none">

      <div id="shown-card-container">
        <img id="shown-card" src="public/images/back.png">
      </div>

      <div id="wagering-deck-container" class="deck-container">
        <div id="wagering-deck" class="deck">
        </div>
      </div>

      <div class="large-card-container">
        <img class="large-card" src="public/images/back.png">
      </div>

      <div class="bottom-nav-container">
        <div class="player-information-container">
          <span>Tokens:</span>
          <span class="player-token-count"> </span>
          <p></p>
          <span>Deck Size:</span>
          <span class="player-deck-size"> </span>
        </div>
        <div id="player-wager-options-container" class="submit-container">
          <label for="player-wager-amount">Wager:</label>
          <input type="number" name="player-wager-amount" id="player-wager-amount">
          <button id="submit-wager" onclick="submitWager()">Submit Wager</button>
        </div>
      </div>
    </div>

    <div id="liquidating-page" style="display: none" class="screen-container">
      <div id="liquidating-deck-container" class="deck-container">
        <div id="liquidating-deck" class="deck">

        </div>
      </div>
      <div class="large-card-container">
        <img class="large-card" src="public/images/back.png">
      </div>
      <div class="bottom-nav-container">
        <div class="player-information-container">
          <span>Tokens:</span>
          <span class="player-token-count"> </span>
          <p></p>
          <span>Deck Size:</span>
          <span class="player-deck-size"> </span>
        </div>
        <div id="player-liquidation-options-container" class="submit-container">
          <button id="liquidate-cards" onclick="submitLiquidate()">Liquidate Card(s)</button>
        </div>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const cardBackImage = "/public/images/back.png";
      const smallCardImageUrl = "https://images.ygoprodeck.com/images/cards_small/";
      const largeCardImageUrl = "https://images.ygoprodeck.com/images/cards/";

      function toggleCardSelect(cardElement){
        if (cardElement.classList.contains("selected-card")) {
          cardElement.classList.remove("selected-card");
        } else {
          cardElement.classList.add("selected-card");
        }
      }

      function submitReadyStatus(status){
        socket.emit("update-readied-status", status);
      }

      function swapReadyStatus(readyButtonElement){
        const elementClass = readyButtonElement.className;
        if (elementClass === "ready"){
          readyButtonElement.className = "not-ready";
          readyButtonElement.innerHTML = "NOT READY";
        } else if (elementClass === "not-ready"){
          readyButtonElement.className = "ready";
          readyButtonElement.innerHTML = "READY";
        }

        submitReadyStatus(readyButtonElement.className === "ready");
      }

      function submitWager(){
        const wagerElement = document.getElementById("player-wager-amount");
        const wager        = wagerElement.value;
        socket.emit("place-wager", wager);
      }

      function submitLiquidate(){
        const liquidateElements = document.getElementsByClassName("selected-card");
        const cardIdsToLiquidate = [];
        for (const cardToLiquidate of liquidateElements){
          cardIdsToLiquidate.push(cardToLiquidate.cardId);
        }
        socket.emit("liquidate-cards", cardIdsToLiquidate);
      }

      function hideAllScreens(){
        const screens = document.getElementsByClassName("screen-container");
        for (const screen of screens){
          screen.style.display = "none";
        }
      }

      function setTokenCount(tokens){
        const tokenElements = document.getElementsByClassName("player-token-count");
        for (const tokenElement of tokenElements){
          tokenElement.innerHTML = tokens;
        }
      }

      function clearDeck(){
        const deckElements = document.getElementsByClassName("deck");
        for (const deckElement of deckElements){
          while (deckElement.firstChild){
            deckElement.removeChild(deckElement.lastChild);
          }
        }
        return deckElements;
      }

      function setWagerCard(cardId){
        const shownCard = document.getElementById("shown-card");
        shownCard.src = largeCardImageUrl + cardId + ".jpg";
      }

      function addCard(cardId, deckElement){
        const card = document.createElement("img");
        card.src = smallCardImageUrl + cardId + ".jpg";
        card.cardId = cardId;
        card.largeImage = largeCardImageUrl + cardId + ".jpg";
        card.onmouseover = () => {
          const largeCardElements = document.getElementsByClassName("large-card");
          for (const largeCardElement of largeCardElements){
            largeCardElement.src = card.largeImage;
          }
        };

        card.onmouseleave = () => {
          const largeCardElements = document.getElementsByClassName("large-card");
          for (const largeCardElement of largeCardElements){
            largeCardElement.src = cardBackImage;
          }
        };

        card.onclick = () => {
          toggleCardSelect(card);
        }

        deckElement.appendChild(card);
      }

      function setDeck(cardList){
        const deckElements = document.getElementsByClassName("deck");
        clearDeck();
        for (const deckElement of deckElements){
          for (const card of cardList){
            addCard(card, deckElement);
          }
        }        
      }

      function submitStartGame(){
        console.log("Starting game");
        socket.emit("start-game");
      }

      function showPlayer1Elements(){
        const player1Elements = document.getElementsByClassName("player-1-element");
        for(const element of player1Elements){
          element.style.display = "";
        }
        console.log("showing player 1 elements");
      }

      socket.on("non-number-wager", () => {
        console.log("Non number wager");
      });

      socket.on("insufficient-tokens", () => {
        console.log("Insufficient tokens");
      });

      socket.on("token-update", (tokensRemaining) => {
        setTokenCount(tokensRemaining);
      });

      socket.on("self-wager-placed", (tokensRemaining) => {
        setTokenCount(tokensRemaining);
      });

      socket.on("wager-card", (cardId) => {
        setWagerCard(cardId);
      });

      socket.on("wager-placed", (playerThatPlacedWager) => {

      });

      socket.on("invalid-liquidation", () => {
        console.log("Invalid liquidation");
      });

      socket.on("change-to-wager-screen", () => {
        const wagerScreen = document.getElementById("wagering-page");
        hideAllScreens();
        wagerScreen.style.display = "";
      });

      socket.on("change-to-liquidate-screen", () => {
        const liquidateScreen = document.getElementById("liquidating-page");
        hideAllScreens();
        liquidateScreen.style.display = "";
      });

      socket.on("update-readied-statuses", (playerStatuses) => {
        let allReady = true;
        for (const player in playerStatuses){
          const playerReady = playerStatuses[player];
          if (allReady && !playerReady){
            allReady = false;
          }
        }

        const startGameButton = document.getElementById("start-game-button");

        if (allReady){
          startGameButton.style.opacity = "1.0";
        } else {
          startGameButton.style.opacity = "0.3";
        }
      });

      socket.on("is-player-1", () => {
        showPlayer1Elements();
      });

      socket.on("card-added", (card) => {

      });

      socket.on("deck", (cardList) => {
        setDeck(cardList);
      });

    </script>
  </body>
</html>